# Caches II

*December 8, 2024*

## Direct Mapped Caches

在**直接映射缓存**中，每个内存地址都与缓存中一个可能的**块**（*block*）相关联。所以，如果数据存在于高速缓存中，我们只需要在高速缓存中的一个位置查找即可；块是高速缓存和内存之间的传输单位。

将内存地址分为三个字段，每个字段都作为无符号整型读取：

- 索引（Index）：
	- 指定缓存的索引（在缓存的哪一”行“/块查找）
- 偏移量（Offset）：
	- 一旦找到了正确的块，指定查找块中的哪个字节
- 标签（Tag）：
	- 确定偏移量和索引后的剩余位
	- 用于区分映射到相同缓存位置的所有内存地址

缓存的空间为 $2^{H+W}=2^H*2^W$ ，H为缓存中块的数量，W为一个块的大小。需要用额外的空间存储缓存中每个块的标签和有效位信息。

![[cache area.png|400]]

举个例子：

- 加载字指令：`lw t0, 0(t1)` 
- t1 包含值 $1022_{ten}$，`Memory[1022] = 99` 

1. 不使用缓存的内存访问

-  处理器向内存发送地址 $1022_{ten}$ 
-  内存读取地址 $1022_{ten}$ 处的字（值为99）
-  内存将 99 发送给处理器
-  处理器将 99 加载到寄存器 t0 中

2. 使用缓存的内存访问

- 处理器向缓存发送地址 $1022_{ten}$ 
-  缓存检查是否有地址 $1022_{ten}$ 的数据副本
	- 如果找到匹配（Hit）：缓存读取 99 并发送给处理器
	-  如果未匹配（Miss）：缓存向内存发送地址 $1022_{ten}$
		- 内存读取地址 $1022_{ten}$ 处的值 99
		- 内存将 99 发送给缓存
		- 缓存用 99 替换原有数据
		- 缓存将 99 发送给处理器
- 处理器将 99 加载到寄存器 t0 中

## Cache Terminology

读取内存时可能发生三种情况：

- 缓存命中（cache **hit**）：缓存块有效且包含正确地址，直接读取所需的字
- 缓存未命中（cache **miss**）：相应的缓存块中没有数据，需要从内存获取
- 缓存未命中且需要块替换（cache miss, **block replacement**）：相应的缓存块中有错误数据，需要丢弃并从内存获取所需数据（缓存始终是副本）

缓存温度：

- 冷（Cold）：缓存为空
- 预热（Warming）：缓存正在填充可能会再次访问的值
- 温（Warm）：缓存正常工作，有合理的命中率
- 热（Hot）：缓存工作非常好，有很高的命中率

缓存术语：

- 命中率：在缓存中命中的访问比例
- 未命中率：1 - 命中率
- 未命中惩罚（Miss penalty）：从内存层次结构的低层替换缓存块所需的时间
- 命中时间（Hit time）：访问缓存内存的时间（包括标签比较）

有效位（Valid Bit）：

- 启动新程序时，缓存没有该程序的有效信息
- 需要一个指示器来表明此标签条目对该程序是否有效
- 在缓存标签条目中添加"有效位"
	- 0：缓存未命中，即使地址恰好等于标签
	- 1：如果处理器地址等于标签，则缓存命中
